<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Impostor Game</title>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
body { font-family: Arial; background:#0f172a; color:white; text-align:center; }
.card { background:#1e293b; padding:20px; border-radius:10px; max-width:400px; margin:auto; }
.hidden { display:none; }
button { padding:10px; margin:5px; width:100%; }
input, select { width:100%; padding:10px; margin:5px; }
.player-item { padding:5px; border-bottom:1px solid #444; }
.vote-btn.selected { background:red; }
</style>
</head>

<body>

<div id="lobby" class="card">
<h2>Impostor Game</h2>
<input id="nameInput" placeholder="Your name">
<button onclick="createRoom()">Create Room</button>
<hr>
<input id="roomInput" placeholder="Room ID">
<button onclick="joinRoom()">Join Room</button>
<p id="status"></p>
</div>

<div id="room" class="card hidden">
<h3 id="roomIdDisplay"></h3>
<select id="category">
<option>Animals</option>
<option>Food</option>
<option>Places</option>
</select>
<button id="startBtn" onclick="startGame()" disabled>Start Game</button>
<ul id="players"></ul>
</div>

<div id="game" class="card hidden">
<h2 id="roleText"></h2>
<p id="wordText"></p>
<button onclick="openVoting()">Open Voting</button>
<div id="votes"></div>
<button onclick="submitVote()">Submit Vote</button>
</div>

<div id="result" class="card hidden">
<h1 id="winner"></h1>
<p id="details"></p>
<button onclick="location.reload()">Restart</button>
</div>

<script>
let peer, conn;
let isHost=false;
let myId,myName;
let players=[];
let votes={};
let myVote=null;
let impostorId;
let secretWord="Dog";

function show(id){
["lobby","room","game","result"].forEach(d=>document.getElementById(d).classList.add("hidden"));
document.getElementById(id).classList.remove("hidden");
}

function createRoom(){
myName=nameInput.value||"Host";
peer=new Peer();
isHost=true;

peer.on("open",id=>{
myId=id;
roomIdDisplay.innerText="Room ID: "+id;
players.push({id,name:myName});
updatePlayers();
show("room");
});

peer.on("connection",c=>{
c.on("data",data=>{
if(data.type==="join"){
players.push({id:c.peer,name:data.name,conn:c});
broadcastPlayers();
}
if(data.type==="vote"){
votes[data.target]=(votes[data.target]||0)+1;
checkVotes();
}
});
});
}

function joinRoom(){
myName=nameInput.value||"Player";
const roomId=roomInput.value;
peer=new Peer();

peer.on("open",id=>{
myId=id;
conn=peer.connect(roomId);

conn.on("open",()=>{
conn.send({type:"join",name:myName});
show("room");
});
conn.on("data",data=>{
if(data.type==="players"){
players=data.players;
updatePlayers();
}
if(data.type==="start"){
showRole(data);
}
if(data.type==="voteOpen"){
showVoting();
}
if(data.type==="result"){
showResult(data);
}
});
});
}

function broadcastPlayers(){
broadcast({type:"players",players});
updatePlayers();
}

function broadcast(data){
players.forEach(p=>{
if(p.conn)p.conn.send(data);
});
}

function updatePlayers(){
playersDiv=players.map(p=>`<li class="player-item">${p.name}</li>`).join("");
playersList=document.getElementById("players");
playersList.innerHTML=playersDiv;
if(players.length>=3) startBtn.disabled=false;
}

function startGame(){
const word="Dog";
impostorId=players[Math.floor(Math.random()*players.length)].id;

players.forEach(p=>{
let payload={
type:"start",
isImpostor:p.id===impostorId,
word:p.id===impostorId?"":word
};
if(p.id===myId) showRole(payload);
else p.conn.send(payload);
});
}

function showRole(data){
show("game");
if(data.isImpostor){
roleText.innerText="YOU ARE IMPOSTOR";
wordText.innerText="Blend in!";
}else{
roleText.innerText="YOU ARE INNOCENT";
wordText.innerText="Word: "+data.word;
}
}

function openVoting(){
broadcast({type:"voteOpen"});
showVoting();
}

function showVoting(){
votesDiv=document.getElementById("votes");
votesDiv.innerHTML="";
players.forEach(p=>{
let b=document.createElement("button");
b.innerText=p.name;
b.onclick=()=>{myVote=p.id;}
votesDiv.appendChild(b);
});
}

function submitVote(){
if(isHost){
votes[myVote]=(votes[myVote]||0)+1;
checkVotes();
}else{
conn.send({type:"vote",target:myVote});
}
}

function checkVotes(){
let total=Object.values(votes).reduce((a,b)=>a+b,0);
if(total>=players.length){
let out=Object.keys(votes).reduce((a,b)=>votes[a]>votes[b]?a:b);
let caught=out===impostorId;
let result={
type:"result",
caught,
impostor:players.find(p=>p.id===impostorId).name,
voted:players.find(p=>p.id===out).name
};
broadcast(result);
showResult(result);
}
}

function showResult(data){
show("result");
winner.innerText=data.caught?"INNOCENTS WIN":"IMPOSTOR WINS";
details.innerText=`${data.voted} was voted out. Impostor was ${data.impostor}`;
}
</script>
</body>
</html>